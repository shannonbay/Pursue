# Pursue ‚Äì Notification Inbox Spec

**Feature:** Notification History Inbox  
**Version:** 1.0  
**Status:** Draft  

---

## 1. Overview

The Notification Inbox is a personal, user-scoped feed of events *directed at the current user*. It lives behind a bell icon (üîî) in the app's top app bar and provides a persistent history of high-signal social interactions ‚Äî reactions on your logs, nudges from group members, and system events like membership approvals or role changes.

### 1.1 Design Philosophy

The group activity feed already serves as the "what happened in my group" timeline. The inbox is deliberately narrower: **it only contains events where someone or the system is speaking directly to you**. This keeps the inbox high-value and preserves the dopamine hit of seeing reactions and nudges without diluting it with ambient group noise.

**In the inbox:**
- Emoji reactions on your progress logs
- Nudges sent to you by group members
- Your membership approval/rejection
- Being promoted to admin
- Being removed from a group

**Not in the inbox (lives in group activity feed only):**
- Other members logging their own progress
- New members joining a group
- Goals being added or archived
- Group renames

**Borderline ‚Äî include as a light variant:**
- Personal milestone moments (first-ever log, 7-day streak, 30-day streak). These are generated by the system and directed at you, so they belong here, but they should be visually distinct (system-style, not social).

### 1.2 Why Not All Group Activity Logs?

The group activity feed already gives users a rich view of group events. Including all activity in the inbox would:
1. Create duplicate content users have to process twice
2. Flood the inbox and devalue reactions/nudges (the real dopamine hits)
3. Confuse the inbox's purpose ‚Äî it should feel like "messages for me", not "a second activity feed"

---

## 2. Notification Types

### 2.1 Reaction Received
**Trigger:** Another member reacts to one of your progress log entries  
**Format:** `{Actor} reacted {emoji} to your {goal_title} log`  
**Example:** `Alex reacted üî• to your 30 min run log`  
**Navigation tap:** Opens the relevant group's activity feed, scrolled to that log entry  

### 2.2 Nudge Received
**Trigger:** A group member sends you a nudge for a goal you haven't logged yet  
**Format:** `{Actor} nudged you on {goal_title} in {group_name}`  
**Example:** `Jamie nudged you on Read 50 pages in Book Club`  
**Navigation tap:** Opens the log entry screen for that goal  

### 2.3 Membership Approved
**Trigger:** An admin approves your join request for a group that requires approval  
**Format:** `Your request to join {group_name} was approved`  
**Navigation tap:** Opens the group  

### 2.4 Membership Rejected
**Trigger:** An admin rejects your join request  
**Format:** `Your request to join {group_name} was not approved`  
**Navigation tap:** Dismisses / no navigation  

### 2.5 Promoted to Admin
**Trigger:** A creator or admin promotes you to admin role  
**Format:** `{Actor} made you an admin in {group_name}`  
**Navigation tap:** Opens the group  

### 2.6 Removed from Group
**Trigger:** An admin removes you from a group  
**Format:** `You were removed from {group_name}`  
**Navigation tap:** No navigation (group no longer accessible)  

### 2.7 Milestone Achieved *(system event)*
**Trigger:** User hits a notable personal milestone  
**Milestones:**
- First ever log in the app
- 7-day streak on a goal
- 30-day streak on a goal
- 100 total logs in the app

**Format:** `üéâ You hit a 7-day streak on {goal_title}!`  
**Navigation tap:** Opens the relevant group or goal  
**Visual:** Uses a distinct "system" chip/badge to distinguish from social interactions  

---

## 3. Database Schema

### 3.1 New Table: `user_notifications`

```sql
CREATE TABLE user_notifications (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type            VARCHAR(50) NOT NULL,
  -- 'reaction_received' | 'nudge_received' | 'membership_approved'
  -- | 'membership_rejected' | 'promoted_to_admin' | 'removed_from_group'
  -- | 'milestone_achieved'
  actor_user_id   UUID REFERENCES users(id) ON DELETE SET NULL,
  -- NULL for system-generated notifications (milestones)
  group_id        UUID REFERENCES groups(id) ON DELETE CASCADE,
  goal_id         UUID REFERENCES goals(id) ON DELETE CASCADE,
  progress_entry_id UUID REFERENCES progress_entries(id) ON DELETE CASCADE,
  metadata        JSONB,
  -- stores: emoji (for reactions), milestone_type, streak_count, etc.
  is_read         BOOLEAN NOT NULL DEFAULT FALSE,
  created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_user_notifications_user      ON user_notifications(user_id, created_at DESC);
CREATE INDEX idx_user_notifications_unread    ON user_notifications(user_id, is_read) WHERE is_read = FALSE;
```

### 3.2 Retention Policy

Notifications are soft-capped at **200 per user**. A nightly cleanup job deletes the oldest notifications beyond that limit. Notifications older than **90 days** are also purged regardless of count. This keeps the table lean and prevents unbounded growth.

---

## 4. API Endpoints

### 4.1 Fetch Inbox

```
GET /api/notifications?limit=30&before_id={cursor_uuid}
Authorization: Bearer {access_token}
```

**Query Parameters:**

| Param | Default | Description |
|---|---|---|
| `limit` | 30 | Max 50 |
| `before_id` | (none) | Cursor for pagination (UUID of last item seen) |

**Response (200 OK):**
```json
{
  "notifications": [
    {
      "id": "notif-uuid",
      "type": "reaction_received",
      "is_read": false,
      "created_at": "2026-02-12T07:45:00Z",
      "actor": {
        "id": "user-uuid",
        "display_name": "Alex Thompson",
        "avatar_url": "https://..."
      },
      "group": {
        "id": "group-uuid",
        "name": "Morning Runners"
      },
      "goal": {
        "id": "goal-uuid",
        "title": "30 min run"
      },
      "progress_entry_id": "entry-uuid",
      "metadata": {
        "emoji": "üî•"
      }
    },
    {
      "id": "notif-uuid-2",
      "type": "milestone_achieved",
      "is_read": true,
      "created_at": "2026-02-11T09:00:00Z",
      "actor": null,
      "group": {
        "id": "group-uuid",
        "name": "Morning Runners"
      },
      "goal": {
        "id": "goal-uuid",
        "title": "30 min run"
      },
      "progress_entry_id": null,
      "metadata": {
        "milestone_type": "streak",
        "streak_count": 7
      }
    }
  ],
  "unread_count": 3,
  "has_more": true
}
```

### 4.2 Get Unread Count

Used to badge the bell icon on app launch and after FCM push.

```
GET /api/notifications/unread-count
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "unread_count": 5
}
```

### 4.3 Mark All as Read

Called when the user opens the inbox screen.

```
POST /api/notifications/mark-all-read
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "marked_read": 5
}
```

### 4.4 Mark Single Notification as Read

```
PATCH /api/notifications/{notification_id}/read
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "id": "notif-uuid",
  "is_read": true
}
```

### 4.5 Delete a Notification

Allows users to dismiss individual notifications.

```
DELETE /api/notifications/{notification_id}
Authorization: Bearer {access_token}
```

**Response (204 No Content)**

---

## 5. Server-Side: Creating Notifications

Notifications are written to `user_notifications` by the same service functions that handle the underlying events. They should be inserted *after* the primary action succeeds, and failures should not block the primary action.

### 5.1 On Reaction Created

```typescript
// After inserting into log_reactions table:
await db.insertInto('user_notifications').values({
  user_id: progressEntry.user_id,      // the log's owner
  type: 'reaction_received',
  actor_user_id: reactingUserId,
  group_id: goal.group_id,
  goal_id: goal.id,
  progress_entry_id: progressEntry.id,
  metadata: { emoji: reaction.emoji }
}).execute();
```

**Skip if:** The reacting user is the same as the log owner (no self-notifications).

### 5.2 On Nudge Sent

```typescript
// After recording the nudge:
await db.insertInto('user_notifications').values({
  user_id: nudgedUserId,
  type: 'nudge_received',
  actor_user_id: nudgingUserId,
  group_id: groupId,
  goal_id: goalId,
  metadata: {}
}).execute();
```

### 5.3 On Membership Approved / Rejected

```typescript
// After updating membership status:
await db.insertInto('user_notifications').values({
  user_id: applicantUserId,
  type: approved ? 'membership_approved' : 'membership_rejected',
  actor_user_id: adminUserId,
  group_id: groupId,
  metadata: {}
}).execute();
```

### 5.4 On Role Change / Removal

```typescript
await db.insertInto('user_notifications').values({
  user_id: affectedUserId,
  type: newRole === 'admin' ? 'promoted_to_admin' : 'removed_from_group',
  actor_user_id: adminUserId,
  group_id: groupId,
  metadata: {}
}).execute();
```

### 5.5 On Milestone Achieved

A milestone check runs after every progress entry is saved. Keep this lightweight ‚Äî check only the conditions relevant to the entry type.

```typescript
async function checkMilestones(userId: string, goalId: string, groupId: string) {
  const totalLogs = await countUserLogs(userId);
  const streak = await getCurrentStreak(userId, goalId);

  const milestones: Array<{ condition: boolean, type: string, metadata: object }> = [
    { condition: totalLogs === 1,   type: 'milestone_achieved', metadata: { milestone_type: 'first_log' } },
    { condition: streak === 7,      type: 'milestone_achieved', metadata: { milestone_type: 'streak', streak_count: 7 } },
    { condition: streak === 30,     type: 'milestone_achieved', metadata: { milestone_type: 'streak', streak_count: 30 } },
    { condition: totalLogs === 100, type: 'milestone_achieved', metadata: { milestone_type: 'total_logs', count: 100 } },
  ];

  for (const m of milestones) {
    if (m.condition) {
      await db.insertInto('user_notifications').values({
        user_id: userId,
        type: m.type,
        actor_user_id: null,
        group_id: groupId,
        goal_id: goalId,
        metadata: m.metadata
      }).execute();
    }
  }
}
```

**Important:** Track which milestones have already been awarded (e.g. a `user_milestone_grants` table or a `metadata` flag) so the same milestone cannot fire twice.

---

## 6. FCM Push Notifications

When a new notification is inserted, an FCM push should be sent to the recipient's registered devices. Use the existing `sendPushToUser(userId, payload)` utility.

### 6.1 Push Payloads by Type

**Reaction received:**
```json
{
  "notification": {
    "title": "Morning Runners",
    "body": "Alex reacted üî• to your 30 min run log"
  },
  "data": {
    "type": "reaction_received",
    "notification_id": "notif-uuid",
    "group_id": "group-uuid"
  }
}
```

**Nudge received:**
```json
{
  "notification": {
    "title": "Jamie is rooting for you!",
    "body": "Don't forget your Read 50 pages in Book Club"
  },
  "data": {
    "type": "nudge_received",
    "notification_id": "notif-uuid",
    "goal_id": "goal-uuid"
  }
}
```

**Milestone achieved:**
```json
{
  "notification": {
    "title": "üéâ 7-day streak!",
    "body": "You've logged 30 min run 7 days in a row. Keep it up!"
  },
  "data": {
    "type": "milestone_achieved",
    "notification_id": "notif-uuid"
  }
}
```

### 6.2 Client Handling

On receiving an FCM push with `data.notification_id` set, the client should:
1. Increment the local unread badge count on the bell icon
2. If the inbox screen is currently open, refresh the notification list

---

## 7. Android UI

### 7.1 Bell Icon & Badge

- Bell icon (üîî) placed in the **top app bar**, right side
- Unread badge: red dot with count (cap display at "9+")
- Badge is fetched on app launch via `GET /api/notifications/unread-count`
- Badge clears when the inbox is opened (triggers `POST /api/notifications/mark-all-read`)

### 7.2 Inbox Screen

**Route:** Launched from top app bar bell icon  
**Title:** "Notifications"  
**Layout:** Vertical `LazyColumn` of notification rows, newest first

**Notification Row Anatomy:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Avatar]  Alex reacted üî• to your 30 min run log    ‚îÇ
‚îÇ           Morning Runners ¬∑ 2 hours ago         [‚óè] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

- **Avatar:** Actor's avatar (or a system icon üéâ for milestones)
- **Body text:** Primary message line (bold if unread)
- **Context line:** Group name ¬∑ relative time (e.g. "2 hours ago", "Yesterday", "Feb 8")
- **Unread dot:** Small blue dot on the right for unread items
- Tapping the row marks it read and navigates per ¬ß2

**Empty state:**
```
üîî
No notifications yet
Reactions and nudges from your groups will appear here.
```

**Loading state:** Shimmer placeholder rows (3‚Äì4 rows)

**Pagination:** Load more automatically as user scrolls to bottom (cursor-based via `before_id`)

### 7.3 Swipe to Dismiss

Each row supports swipe-left to delete. Uses Material 3 `SwipeToDismiss` composable. Calls `DELETE /api/notifications/{id}` on confirm.

### 7.4 Notification Type Visual Variants

| Type | Avatar | Accent | Icon overlay |
|---|---|---|---|
| Reaction received | Actor avatar | None | Emoji in bottom-right corner of avatar |
| Nudge received | Actor avatar | None | üëã in bottom-right corner |
| Membership approved | Group icon | Green left border | ‚úÖ |
| Membership rejected | Group icon | Muted left border | ‚úñ |
| Promoted to admin | Actor avatar | None | ‚≠ê |
| Removed from group | Group icon | Muted left border | ‚úñ |
| Milestone achieved | üéâ system icon | Gold left border | None |

---

## 8. Notification Preferences (Future)

In v1, all notification types are on by default with no per-type toggle. A future `Notification Settings` screen could let users silence specific types (e.g. disable milestone notifications but keep reactions/nudges).

---

## 9. Implementation Checklist

### Backend
- [ ] Create `user_notifications` table and indexes
- [ ] Create nightly cleanup job (90-day / 200-item cap)
- [ ] `GET /api/notifications` endpoint with cursor pagination
- [ ] `GET /api/notifications/unread-count` endpoint
- [ ] `POST /api/notifications/mark-all-read` endpoint
- [ ] `PATCH /api/notifications/{id}/read` endpoint
- [ ] `DELETE /api/notifications/{id}` endpoint
- [ ] Insert notification on reaction created (skip self-reaction)
- [ ] Insert notification on nudge sent
- [ ] Insert notification on membership approved/rejected
- [ ] Insert notification on role change / member removed
- [ ] Milestone checker function after progress entry saved
- [ ] Milestone deduplication guard
- [ ] FCM push on notification insert (all types)

### Android
- [ ] `NotificationRepository` ‚Äî fetch, mark read, delete
- [ ] `NotificationViewModel`
- [ ] `InboxScreen` composable (LazyColumn, empty state, loading shimmer)
- [ ] `NotificationRow` composable with avatar, unread dot, swipe-to-dismiss
- [ ] Bell icon + badge in `TopAppBar`
- [ ] Unread count fetch on app launch
- [ ] Badge clear on inbox open
- [ ] FCM handler: increment badge, refresh inbox if open
- [ ] Navigate-on-tap logic per notification type

---

## 10. Open Questions

1. **Notification grouping:** If Alex reacts üî• üî• üî• three times in quick succession, should these be collapsed into one row ("Alex reacted 3 times to your log")? Recommended: yes, collapse within a 5-minute window on the server before inserting.

2. **Multiple reactors:** If Alex *and* Jamie both react to the same log, show as "Alex and Jamie reacted to your 30 min run log"? Or two separate rows? Separate rows is simpler for v1; grouping can come later.

3. **Milestone deduplication table:** Use a simple `user_milestone_grants(user_id, milestone_key)` table with a unique constraint, or store awarded milestones in `users.metadata` JSONB? Recommend the dedicated table for clarity.

4. **Removed-from-group notifications:** Once a user is removed, their `group_id` foreign key will point to a group they can no longer access. The notification row's navigation tap should handle this gracefully ‚Äî show a toast ("You're no longer a member of this group") rather than navigating.
