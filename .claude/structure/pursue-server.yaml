# pursue-server structure index
module: pursue-server
root: pursue-server/src
description: Express.js backend API with TypeScript, PostgreSQL/Kysely, JWT auth, and Firebase Cloud Messaging

directories:
  - name: controllers/
    description: Route handlers that process requests and call services/db
  - name: services/
    description: Business logic including auth, subscriptions, FCM, and utilities
  - name: routes/
    description: Express route definitions with middleware and handlers
  - name: middleware/
    description: Express middleware for authentication, error handling, rate limiting
  - name: database/
    description: Kysely ORM configuration and type definitions
  - name: utils/
    description: Utility functions for JWT, passwords, logging
  - name: validations/
    description: Zod schemas for request validation
  - name: types/
    description: TypeScript type definitions

files:

  # Core app setup
  app.ts:
    description: Express app factory with middleware setup, CORS, health check endpoint
    exports:
      - name: app
        kind: export
        type: Express Application instance
    imports:
      - from: database/index
        items: [db]
      - from: middleware/errorHandler
        items: [errorHandler]
      - from: middleware/rateLimiter
        items: [apiLimiter]
      - from: routes/*
        items: [all route handlers]

  server.ts:
    description: Server startup with environment validation and port configuration
    imports:
      - from: app
        items: [app]

  # Database layer
  database/index.ts:
    description: Kysely database connection and type-safe query builder initialization
    exports:
      - name: db
        kind: export
        type: Kysely<Database> instance
    imports:
      - from: database/types
        items: [Database type]

  database/types.ts:
    description: Kysely table interfaces (Users, Groups, Goals, Progress, etc.) and type utilities
    exports:
      - name: Database
        kind: interface
        description: Root database schema mapping all tables
      - name: User
        kind: type
        description: Selectable user row
      - name: NewUser
        kind: type
        description: Insertable user (omits generated fields)
      - name: UserUpdate
        kind: type
        description: Updatable user fields
      - name: Group
        kind: type
      - name: GroupMembership
        kind: type
      - name: Goal
        kind: type
      - name: ProgressEntry
        kind: type
      - name: Device
        kind: type
      - name: UserSubscription
        kind: type
      - name: GroupActivity
        kind: type
      - name: InviteCode
        kind: type
      - name: PasswordResetToken
        kind: type
      - name: RefreshToken
        kind: type
      - name: AuthProvider
        kind: type
      - name: SubscriptionDowngradeHistory
        kind: type
      - name: SubscriptionTransaction
        kind: type

  # Controllers (Request Handlers)
  controllers/auth.ts:
    description: Authentication endpoints (register, login, Google OAuth, refresh, password reset)
    exports:
      - name: register
        kind: function
        params: [{name: req, type: AuthRequest}, {name: res, type: Response}, {name: next, type: NextFunction}]
        returns: Promise<void>
        description: POST /api/auth/register - Create new user with email/password
      - name: login
        kind: function
        description: POST /api/auth/login - Authenticate with email/password
      - name: googleAuth
        kind: function
        description: POST /api/auth/google - Sign in/register with Google OAuth
      - name: refresh
        kind: function
        description: POST /api/auth/refresh - Rotate refresh token for new access token
      - name: logout
        kind: function
        description: POST /api/auth/logout - Revoke refresh token
      - name: forgotPassword
        kind: function
        description: POST /api/auth/forgot-password - Initiate password reset
      - name: resetPassword
        kind: function
        description: POST /api/auth/reset-password - Complete password reset with token
      - name: linkGoogle
        kind: function
        description: POST /api/auth/link/google - Link Google account to existing user
      - name: unlinkProvider
        kind: function
        description: DELETE /api/auth/unlink/:provider - Unlink auth provider
    imports:
      - from: database/index
        items: [db]
      - from: utils/jwt
        items: [generateAccessToken, generateRefreshToken, verifyRefreshToken, hashToken, generateRandomToken]
      - from: utils/password
        items: [hashPassword, verifyPassword]
      - from: services/googleAuth
        items: [verifyGoogleIdToken]
      - from: middleware/errorHandler
        items: [ApplicationError]

  controllers/users.ts:
    description: User profile endpoints (avatar upload/download, settings, subscription, groups)
    exports:
      - name: uploadAvatar
        kind: export
        type: Express middleware array
        description: POST /api/users/me/avatar - Upload user avatar
      - name: getUserAvatar
        kind: function
        description: GET /api/users/:user_id/avatar - Download user avatar with caching
      - name: deleteAvatar
        kind: function
        description: DELETE /api/users/me/avatar - Remove user avatar
      - name: getCurrentUser
        kind: function
        description: GET /api/users/me - Get current user profile
      - name: updateCurrentUser
        kind: function
        description: PATCH /api/users/me - Update display name
      - name: changePassword
        kind: function
        description: POST /api/users/me/password - Change password (with optional current password verification)
      - name: getAuthProviders
        kind: function
        description: GET /api/users/me/providers - List linked auth providers
      - name: getSubscription
        kind: function
        description: GET /api/users/me/subscription - Get subscription state and group limits
      - name: getSubscriptionEligibilityHandler
        kind: function
        description: GET /api/users/me/subscription/eligibility - Check upgrade eligibility
      - name: getUserGroups
        kind: function
        description: GET /api/users/me/groups - List user's groups with pagination
      - name: deleteCurrentUser
        kind: function
        description: DELETE /api/users/me - Soft delete user account (requires password)
    imports:
      - from: database/index
        items: [db]
      - from: services/storage.service
        items: [uploadUserAvatar, deleteUserAvatar]
      - from: services/subscription.service
        items: [getUserSubscriptionState, getSubscriptionEligibility]
      - from: utils/password
        items: [hashPassword, verifyPassword]

  controllers/groups.ts:
    description: Group management endpoints (CRUD, members, invites, activity, exports)
    exports:
      - name: createGroup
        kind: function
        description: POST /api/groups - Create new group with optional initial goals
      - name: getGroup
        kind: function
        description: GET /api/groups/:group_id - Get group details with member count
      - name: updateGroup
        kind: function
        description: PATCH /api/groups/:group_id - Update group name, description, icon emoji/color (admin only)
      - name: uploadIcon
        kind: export
        type: Express middleware array
        description: PATCH /api/groups/:group_id/icon - Upload group icon image (admin only)
      - name: getGroupIcon
        kind: function
        description: GET /api/groups/:group_id/icon - Download group icon with caching
      - name: deleteIcon
        kind: function
        description: DELETE /api/groups/:group_id/icon - Remove group icon
      - name: deleteGroup
        kind: function
        description: DELETE /api/groups/:group_id - Delete group (creator only, cascade deletes all related data)
      - name: listPendingMembers
        kind: function
        description: GET /api/groups/:group_id/members/pending - List pending join requests (admin only)
      - name: approveMember
        kind: function
        description: POST /api/groups/:group_id/members/:user_id/approve - Approve pending member (admin only)
      - name: declineMember
        kind: function
        description: POST /api/groups/:group_id/members/:user_id/decline - Decline pending member (admin only)
      - name: listMembers
        kind: function
        description: GET /api/groups/:group_id/members - List active group members sorted by role then joined_at
      - name: updateMemberRole
        kind: function
        description: PATCH /api/groups/:group_id/members/:user_id - Promote/demote member (admin only)
      - name: removeMember
        kind: function
        description: DELETE /api/groups/:group_id/members/:user_id - Remove member from group (admin only)
      - name: leaveGroup
        kind: function
        description: DELETE /api/groups/:group_id/members/me - Leave group (auto-promotes replacement if last admin)
      - name: getGroupInvite
        kind: function
        description: GET /api/groups/:group_id/invite - Get active invite code for sharing
      - name: regenerateInviteCode
        kind: function
        description: POST /api/groups/:group_id/invite/regenerate - Revoke old and create new invite code (admin only)
      - name: joinGroup
        kind: function
        description: POST /api/groups/join - Join group with invite code (creates pending membership)
      - name: getActivity
        kind: function
        description: GET /api/groups/:group_id/activity - Get group activity feed with pagination
      - name: validateExportRange
        kind: function
        description: GET /api/groups/:group_id/export-progress/validate-range - Validate export date range against tier
      - name: exportGroupProgress
        kind: function
        description: GET /api/groups/:group_id/export-progress - Generate Excel workbook with progress data
    imports:
      - from: database/index
        items: [db]
      - from: services/authorization
        items: [ensureGroupExists, requireGroupMember, requireGroupAdmin, requireGroupCreator, requireActiveGroupMember]
      - from: services/subscription.service
        items: [canUserJoinOrCreateGroup, validateExportDateRange]
      - from: services/activity.service
        items: [createGroupActivity, ACTIVITY_TYPES]
      - from: services/fcm.service
        items: [sendGroupNotification, sendNotificationToUser, sendPushNotification, sendToTopic, buildTopicName]
      - from: services/storage.service
        items: [uploadGroupIcon, deleteGroupIcon]
      - from: services/exportProgress.service
        items: [sanitizeSheetName, addLetterhead, generateSummarySection, generateCalendarSection]

  controllers/goals.ts:
    description: Goal endpoints (CRUD, progress tracking with per-period calculations)
    exports:
      - name: createGoal
        kind: function
        description: POST /api/groups/:group_id/goals - Create goal with cadence, metric, targets (admin only)
      - name: listGoals
        kind: function
        description: GET /api/groups/:group_id/goals - List group goals with optional progress attachment
      - name: getGoal
        kind: function
        description: GET /api/goals/:goal_id - Get single goal details
      - name: updateGoal
        kind: function
        description: PATCH /api/goals/:goal_id - Update goal title/description (admin only)
      - name: deleteGoal
        kind: function
        description: DELETE /api/goals/:goal_id - Soft delete goal (admin only)
      - name: getProgress
        kind: function
        description: GET /api/goals/:goal_id/progress - Get progress entries for all members (with date range filter)
      - name: getProgressMe
        kind: function
        description: GET /api/goals/:goal_id/progress/me - Get current user's progress entries
    imports:
      - from: database/index
        items: [db]
      - from: services/authorization
        items: [ensureGroupExists, ensureGoalExists, requireGroupMember, requireActiveGroupMember, requireGroupAdmin]
      - from: services/subscription.service
        items: [canUserWriteInGroup]
      - from: services/activity.service
        items: [createGroupActivity, ACTIVITY_TYPES]
      - from: services/fcm.service
        items: [sendToTopic, buildTopicName]

  controllers/progress.ts:
    description: Progress entry endpoints (log daily/weekly/monthly progress)
    exports:
      - name: createProgress
        kind: function
        description: POST /api/progress - Log progress entry (calculates period_start from cadence)
      - name: getProgress
        kind: function
        description: GET /api/progress/:entry_id - Get progress entry (owner or group member)
      - name: deleteProgress
        kind: function
        description: DELETE /api/progress/:entry_id - Delete progress entry (owner only)
    imports:
      - from: database/index
        items: [db]
      - from: services/authorization
        items: [ensureGoalExists, requireGroupMember, requireActiveGroupMember]
      - from: services/subscription.service
        items: [canUserWriteInGroup]
      - from: services/activity.service
        items: [createGroupActivity, ACTIVITY_TYPES]
      - from: services/fcm.service
        items: [sendToTopic, buildTopicName]

  controllers/devices.ts:
    description: Device registration for FCM notifications
    exports:
      - name: registerDevice
        kind: function
        description: POST /api/devices/register - Register or update device with FCM token (upsert by fcm_token)
      - name: listDevices
        kind: function
        description: GET /api/devices - List user's registered devices
      - name: unregisterDevice
        kind: function
        description: DELETE /api/devices/:device_id - Unregister device
    imports:
      - from: database/index
        items: [db]
      - from: middleware/errorHandler
        items: [ApplicationError]

  controllers/subscriptions.ts:
    description: Subscription management endpoints (upgrade, verify, cancel, downgrade)
    exports:
      - name: upgrade
        kind: function
        description: POST /api/subscriptions/upgrade - Create premium subscription with purchase token
      - name: verify
        kind: function
        description: POST /api/subscriptions/verify - Verify purchase with platform (supports webhook)
      - name: cancel
        kind: function
        description: POST /api/subscriptions/cancel - Cancel premium subscription (keeps access until expires_at)
      - name: downgradeSelectGroup
        kind: function
        description: POST /api/subscriptions/downgrade/select-group - User in over_limit state selects group to keep
    imports:
      - from: database/index
        items: [db]
      - from: services/subscription.service
        items: [createOrRenewPremiumSubscription, cancelSubscription, selectGroupOnDowngrade, verifyPurchase]

  # Services (Business Logic)
  services/authorization.ts:
    description: Authorization checks for group membership, roles, and goal access
    exports:
      - name: ensureGoalExists
        kind: function
        params: [{name: goalId, type: string}]
        returns: Promise<GoalRow>
        description: Verify goal exists and is not soft-deleted; throws 404
      - name: ensureGroupExists
        kind: function
        params: [{name: groupId, type: string}]
        returns: Promise<void>
        description: Verify group exists; throws 404
      - name: getGroupMembership
        kind: function
        params: [{name: userId, type: string}, {name: groupId, type: string}]
        returns: Promise<GroupMembershipResult | null>
        description: Get user's membership record or null if not member
      - name: requireGroupMember
        kind: function
        description: Ensure user is member of group; throws 403
      - name: requireActiveGroupMember
        kind: function
        description: Ensure user is active member (not pending/declined); throws 403 or PENDING_APPROVAL
      - name: requireGroupAdmin
        kind: function
        description: Ensure user is admin or creator; throws 403
      - name: requireGroupCreator
        kind: function
        description: Ensure user is creator; throws 403

  services/subscription.service.ts:
    description: Subscription tier logic, group limits, export date validation, downgrade handling
    exports:
      - name: getActiveGroupCount
        kind: function
        params: [{name: userId, type: string}]
        returns: Promise<number>
        description: Count active group memberships
      - name: getUserSubscriptionState
        kind: function
        params: [{name: userId, type: string}]
        returns: Promise<UserSubscriptionState | null>
        description: Get user's tier, status, group_limit, current_group_count
      - name: updateSubscriptionStatus
        kind: function
        params: [{name: userId, type: string}]
        returns: Promise<void>
        description: Sync user subscription state from user_subscriptions table
      - name: canUserJoinOrCreateGroup
        kind: function
        params: [{name: userId, type: string}]
        returns: Promise<{allowed: boolean, reason?: string}>
        description: Check if user can join/create group (tier + limits)
      - name: canUserWriteInGroup
        kind: function
        params: [{name: userId, type: string}, {name: groupId, type: string}]
        returns: Promise<CanUserWriteInGroupResult>
        description: Check if user can write (not in read-only/over_limit state)
      - name: getSubscriptionEligibility
        kind: function
        params: [{name: userId, type: string}]
        returns: Promise<SubscriptionEligibility | null>
        description: Get group creation/joining eligibility info
      - name: validateExportDateRange
        kind: function
        params: [{name: userId, type: string}, {name: startDate, type: string}, {name: endDate, type: string}]
        returns: Promise<ExportRangeValidation | null>
        description: Validate export range respects tier limits (30 days free, 365 premium)
      - name: createOrRenewPremiumSubscription
        kind: function
        description: Create or renew premium subscription from platform purchase
      - name: verifyPurchase
        kind: function
        description: Verify purchase with platform (Google Play or App Store)
      - name: cancelSubscription
        kind: function
        params: [{name: userId, type: string}]
        returns: Promise<{status, access_until, auto_renew, message}>
        description: Cancel premium subscription (access available until expires_at)
      - name: selectGroupOnDowngrade
        kind: function
        params: [{name: userId, type: string}, {name: keepGroupId, type: string}]
        returns: Promise<{status, kept_group, removed_groups, read_only_access_until}>
        description: User in over_limit selects one group to keep, others become read-only

  services/fcm.service.ts:
    description: Firebase Cloud Messaging for push notifications and group topics
    exports:
      - name: sendPushNotification
        kind: function
        params: [{name: deviceToken, type: string}, {name: title, type: string}, {name: body, type: string}, {name: data, type: Record<string, string>}]
        returns: Promise<void>
        description: Send push notification to single device; removes invalid tokens
      - name: sendGroupNotification
        kind: function
        params: [{name: groupId, type: string}, {name: notification, type: GroupNotificationPayload}, {name: data, type: Record<string, string>}, {name: options, type: SendGroupNotificationOptions}]
        returns: Promise<void>
        description: Send push notification to all group members
      - name: sendNotificationToUser
        kind: function
        description: Send push notification to all user's devices
      - name: sendToTopic
        kind: function
        params: [{name: topicName, type: string}, {name: notification, type: {title, body}}, {name: data, type: Record<string, string>}]
        returns: Promise<void>
        description: Send message to FCM topic (e.g., group_events, progress_logs)
      - name: buildTopicName
        kind: function
        params: [{name: groupId, type: string}, {name: topicType, type: string}]
        returns: string
        description: Build standardized topic name (e.g., group_{id}_group_events)

  services/activity.service.ts:
    description: Group activity logging for feeds
    exports:
      - name: ACTIVITY_TYPES
        kind: export
        type: const object
        description: Activity type constants (group_created, member_joined, goal_added, progress_logged, etc.)
      - name: createGroupActivity
        kind: function
        params: [{name: groupId, type: string}, {name: activityType, type: string}, {name: userId, type: string | null}, {name: metadata, type: Record<string, unknown>}]
        returns: Promise<void>
        description: Create group_activities entry for feed

  services/googleAuth.ts:
    description: Google OAuth token verification with multi-client support
    exports:
      - name: verifyGoogleIdToken
        kind: function
        params: [{name: idToken, type: string}]
        returns: Promise<GoogleUserInfo>
        description: Verify Google ID token and extract user info (sub, email, name, picture)
      - name: GoogleUserInfo
        kind: interface
        description: Verified Google user data

  services/storage.service.ts:
    description: Image storage (upload/delete avatars and group icons)
    exports:
      - name: uploadUserAvatar
        kind: function
        description: Upload and process user avatar (resize to 256x256, convert to WebP)
      - name: deleteUserAvatar
        kind: function
        description: Delete user avatar from database
      - name: uploadGroupIcon
        kind: function
        description: Upload and process group icon (similar to avatar)
      - name: deleteGroupIcon
        kind: function
        description: Delete group icon from database

  services/exportProgress.service.ts:
    description: Excel workbook generation for progress exports
    exports:
      - name: sanitizeSheetName
        kind: function
        description: Clean sheet names for Excel compatibility
      - name: sanitizeFilename
        kind: function
        description: Clean filenames for download headers
      - name: addLetterhead
        kind: function
        description: Add letterhead image to worksheet
      - name: generateSummarySection
        kind: function
        description: Create summary table with member progress stats
      - name: generateCalendarSection
        kind: function
        description: Create calendar grid showing progress over date range
      - name: ExportGoal
        kind: type
      - name: ExportProgressEntry
        kind: type

  # Middleware
  middleware/authenticate.ts:
    description: JWT bearer token verification middleware
    exports:
      - name: authenticate
        kind: function
        params: [{name: req, type: AuthRequest}, {name: res, type: Response}, {name: next, type: NextFunction}]
        returns: Promise<void>
        description: Extract and verify JWT from Authorization header; attach req.user
    imports:
      - from: utils/logger
        items: [logger]

  middleware/errorHandler.ts:
    description: Global error handler for ApplicationError, Zod, Multer, Sharp, and generic errors
    exports:
      - name: ApplicationError
        kind: class
        params: [{name: message, type: string}, {name: statusCode, type: number}, {name: code, type: string}]
        description: Custom error class with status code and error code
      - name: errorHandler
        kind: function
        params: [{name: error, type: Error}, {name: req, type: Request}, {name: res, type: Response}, {name: _next, type: NextFunction}]
        returns: void
        description: Global error middleware; handles ApplicationError, Zod, Multer, Sharp, DB constraint errors

  middleware/rateLimiter.ts:
    description: Rate limiting for auth endpoints and general API
    exports:
      - name: apiLimiter
        kind: export
        description: Rate limiter for general API endpoints
      - name: authLimiter
        kind: export
        description: Stricter rate limiter for auth (register/login/google)
      - name: passwordResetLimiter
        kind: export
        description: Rate limiter for password reset endpoints

  middleware/index.ts:
    description: Middleware barrel export
    imports:
      - from: authenticate
        items: [authenticate]
      - from: errorHandler
        items: [errorHandler, ApplicationError]
      - from: rateLimiter
        items: [apiLimiter, authLimiter, passwordResetLimiter]

  # Routes (Endpoint Definitions)
  routes/auth.ts:
    description: Auth route definitions with controller mappings and rate limiting
    exports:
      - name: default (router)
        kind: export
        type: Express Router
    imports:
      - from: controllers/auth
        items: [register, login, googleAuth, refresh, logout, forgotPassword, resetPassword, linkGoogle, unlinkProvider]
      - from: middleware/authenticate
        items: [authenticate]
      - from: middleware/rateLimiter
        items: [authLimiter, passwordResetLimiter]

  routes/users.ts:
    description: User routes (profile, avatar, subscription)
    imports:
      - from: controllers/users
        items: [all user handlers]
      - from: middleware/authenticate
        items: [authenticate]

  routes/groups.ts:
    description: Group routes (CRUD, members, invites, activity, exports)
    imports:
      - from: controllers/groups
        items: [all group handlers]
      - from: middleware/authenticate
        items: [authenticate]

  routes/goals.ts:
    description: Goal routes (CRUD, progress tracking)
    imports:
      - from: controllers/goals
        items: [all goal handlers]
      - from: middleware/authenticate
        items: [authenticate]

  routes/progress.ts:
    description: Progress entry routes
    imports:
      - from: controllers/progress
        items: [createProgress, getProgress, deleteProgress]
      - from: middleware/authenticate
        items: [authenticate]

  routes/devices.ts:
    description: Device registration routes for FCM
    imports:
      - from: controllers/devices
        items: [registerDevice, listDevices, unregisterDevice]
      - from: middleware/authenticate
        items: [authenticate]

  routes/subscriptions.ts:
    description: Subscription management routes
    imports:
      - from: controllers/subscriptions
        items: [upgrade, verify, cancel, downgradeSelectGroup]
      - from: middleware/authenticate
        items: [authenticate]

  # Utilities
  utils/jwt.ts:
    description: JWT token generation and verification
    exports:
      - name: generateAccessToken
        kind: function
        params: [{name: userId, type: string}, {name: email, type: string}]
        returns: string
        description: Create 1h expiry access token
      - name: generateRefreshToken
        kind: function
        params: [{name: userId, type: string}, {name: tokenId, type: string}]
        returns: string
        description: Create 30d expiry refresh token
      - name: verifyAccessToken
        kind: function
        params: [{name: token, type: string}]
        returns: AccessTokenPayload
        description: Verify and decode access token
      - name: verifyRefreshToken
        kind: function
        params: [{name: token, type: string}]
        returns: RefreshTokenPayload
        description: Verify and decode refresh token
      - name: hashToken
        kind: function
        params: [{name: token, type: string}]
        returns: string
        description: SHA256 hash token for database storage
      - name: generateRandomToken
        kind: function
        returns: string
        description: Generate 32-byte random hex token
      - name: getRefreshTokenExpiryDate
        kind: function
        returns: Date
        description: Calculate expiry date 30 days from now
      - name: getPasswordResetExpiryDate
        kind: function
        returns: Date
        description: Calculate expiry date 1 hour from now

  utils/password.ts:
    description: Password hashing and verification
    exports:
      - name: hashPassword
        kind: function
        params: [{name: password, type: string}]
        returns: Promise<string>
        description: Hash password with bcrypt (10 salt rounds)
      - name: verifyPassword
        kind: function
        params: [{name: password, type: string}, {name: hash, type: string}]
        returns: Promise<boolean>
        description: Compare password with bcrypt hash

  utils/logger.ts:
    description: Winston logger configuration for development and production
    exports:
      - name: logger
        kind: export
        type: Winston Logger instance
        description: Configured logger with console and file transports

  # Type Definitions
  types/express.ts:
    description: Express request type extensions
    exports:
      - name: AuthUser
        kind: interface
        description: User attached to request (id, email)
      - name: AuthRequest
        kind: interface
        description: Extended Express Request with optional user property

  # Validation Schemas (Zod)
  validations/auth.ts:
    description: Zod validation schemas for auth endpoints
    exports:
      - name: RegisterSchema
        kind: export
        type: Zod schema
      - name: LoginSchema
        kind: export
        type: Zod schema
      - name: GoogleAuthSchema
        kind: export
        type: Zod schema
      - name: RefreshTokenSchema
        kind: export
        type: Zod schema
      - name: ForgotPasswordSchema
        kind: export
        type: Zod schema
      - name: ResetPasswordSchema
        kind: export
        type: Zod schema
      - name: LinkGoogleSchema
        kind: export
        type: Zod schema

  validations/users.ts:
    description: Zod validation schemas for user endpoints
    exports:
      - name: UpdateUserSchema
        kind: export
        type: Zod schema
      - name: ChangePasswordSchema
        kind: export
        type: Zod schema
      - name: DeleteUserSchema
        kind: export
        type: Zod schema
      - name: GetGroupsQuerySchema
        kind: export
        type: Zod schema

  validations/groups.ts:
    description: Zod validation schemas for group endpoints
    exports:
      - name: CreateGroupSchema
        kind: export
        type: Zod schema
      - name: UpdateGroupSchema
        kind: export
        type: Zod schema
      - name: UpdateMemberRoleSchema
        kind: export
        type: Zod schema
      - name: JoinGroupSchema
        kind: export
        type: Zod schema
      - name: ExportProgressQuerySchema
        kind: export
        type: Zod schema

  validations/goals.ts:
    description: Zod validation schemas for goal endpoints
    exports:
      - name: CreateGoalSchema
        kind: export
        type: Zod schema
      - name: UpdateGoalSchema
        kind: export
        type: Zod schema
      - name: ProgressQuerySchema
        kind: export
        type: Zod schema
      - name: ListGoalsQuerySchema
        kind: export
        type: Zod schema

  validations/progress.ts:
    description: Zod validation schemas for progress endpoints
    exports:
      - name: CreateProgressSchema
        kind: export
        type: Zod schema

  validations/devices.ts:
    description: Zod validation schemas for device endpoints
    exports:
      - name: RegisterDeviceSchema
        kind: export
        type: Zod schema

  validations/subscriptions.ts:
    description: Zod validation schemas for subscription endpoints
    exports:
      - name: UpgradeSubscriptionSchema
        kind: export
        type: Zod schema
      - name: VerifySubscriptionSchema
        kind: export
        type: Zod schema
      - name: DowngradeSelectGroupSchema
        kind: export
        type: Zod schema
      - name: ValidateExportRangeQuerySchema
        kind: export
        type: Zod schema

# Key patterns and conventions
patterns:
  authentication:
    - Bearer token JWT in Authorization header (verified by authenticate middleware)
    - Access tokens (1h expiry) in memory, refresh tokens (30d expiry) hashed in database
    - req.user contains {id, email} after authentication
    - Throws 401/UNAUTHORIZED if missing or invalid token

  database:
    - Kysely query builder with type-safe SQL
    - DATE columns parsed as YYYY-MM-DD strings (not Date objects)
    - Soft deletes on users, groups, goals (filter with deleted_at IS NULL)
    - DB triggers enforce hard caps on groups/members/goals

  authorization:
    - requireGroupMember: checks membership (any status)
    - requireActiveGroupMember: checks status='active' (pending/declined excluded)
    - requireGroupAdmin: checks role='admin' OR role='creator'
    - requireGroupCreator: checks role='creator' only
    - Throws 403/FORBIDDEN or PENDING_APPROVAL

  errors:
    - All errors caught by global errorHandler middleware
    - ApplicationError(message, statusCode, code) for business logic
    - Zod validation errors return 400 with details array
    - Multer file errors return 400/FILE_TOO_LARGE
    - Sharp image errors return 400/INVALID_IMAGE
    - DB constraint errors return 429/RESOURCE_LIMIT_EXCEEDED

  rate_limiting:
    - apiLimiter on all /api routes (default window)
    - authLimiter stricter on auth endpoints (register, login, google)
    - passwordResetLimiter on password endpoints
    - Automatically disabled when NODE_ENV=test

  subscriptions:
    - FREE_GROUP_LIMIT = 1, PREMIUM_GROUP_LIMIT = 10
    - FREE_EXPORT_DAYS = 30, PREMIUM_EXPORT_DAYS = 365
    - Tiers: free, premium
    - Statuses: active, cancelled, expired, grace_period, over_limit
    - Free users with >1 group enter over_limit state (must select group to keep)

  fcm_notifications:
    - Topics: {group_id}_group_events, {group_id}_progress_logs
    - Sends to all devices of group members
    - Removes invalid tokens automatically on send failure
    - Does not throw if Firebase not configured

  images:
    - Processed to WebP 256x256 with Sharp
    - Stored as BYTEA in database
    - ETag caching with If-None-Match support
    - Cache-Control: public, max-age=86400

  transactions:
    - Used in createGroup (group + membership + invite + goals + activity)
    - Used in regenerateInviteCode (revoke old + create new + activity)
    - Used in subscription/downgrade flows
